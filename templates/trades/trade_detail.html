{% extends 'base.html' %}

{% block title %}Trade #{{ trade.pk }} | KeystoneBid{% endblock %}

{% block content %}
<section style="display: grid; gap: 1rem;">
    <article class="card">
        <h1 style="margin-bottom: 0.5rem;">Trade #{{ trade.pk }}</h1>
        <p>Listing: <a href="{% url 'listings:detail' trade.listing.pk %}">{{ trade.listing.title }}</a></p>
        <p style="color: var(--color-muted);">
            {{ trade.initiator.username }} <-> {{ trade.counterparty.username }} |
            {{ trade.get_status_display }} |
            Ship by {{ trade.ship_by_deadline|date:"M j, Y g:i a" }}
        </p>
    </article>

    {% if accepted_offer %}
    <article class="card">
        <h2 style="font-size: 1.2rem; margin-bottom: 0.6rem;">Accepted Offer Terms</h2>
        <div style="display: grid; gap: 0.45rem;">
            {% for item in accepted_offer.items.all %}
                <p>
                    {% if item.direction == 'offered' %}<strong>Offered:</strong>{% else %}<strong>Requested:</strong>{% endif %}
                    {{ item.collection_item.title }}
                </p>
            {% endfor %}
            {% if accepted_offer.cash_amount %}
                <p><strong>Cash add-on:</strong> ${{ accepted_offer.cash_amount }}</p>
            {% endif %}
        </div>
    </article>
    {% endif %}

    <article class="card">
        <h2 style="font-size: 1.2rem; margin-bottom: 0.6rem;">Trade Shipping</h2>
        <p style="color: var(--color-muted); margin-bottom: 0.75rem;">
            Both sides must provide tracking and confirm receipt to complete the trade.
        </p>
        <div style="display: grid; gap: 1rem;">
            {% for shipment in trade.shipments.all %}
                <div style="padding: 0.75rem; border: 1px solid #ddd; border-radius: 10px; background: #fff;">
                    <p style="margin-bottom: 0.35rem;">
                        <strong>{{ shipment.sender.username }}</strong> -> <strong>{{ shipment.recipient.username }}</strong>
                    </p>
                    <p style="margin-bottom: 0.25rem;">Status: {{ shipment.get_status_display }}</p>
                    <p style="margin-bottom: 0.25rem;">Carrier: {{ shipment.carrier|default:'Not set' }}</p>
                    <p style="margin-bottom: 0.25rem;">Tracking: {{ shipment.tracking_number|default:'Not set' }}</p>
                    {% if shipment.label_url %}
                        <p style="margin-bottom: 0.25rem;">
                            <a href="{{ shipment.label_url }}" target="_blank" rel="noopener">View label</a>
                        </p>
                    {% endif %}
                    {% if shipment.delivered_at %}
                        <p style="margin-bottom: 0.25rem;">Delivered: {{ shipment.delivered_at|date:"M j, Y g:i a" }}</p>
                    {% endif %}
                    {% if shipment.recipient_confirmed_at %}
                        <p style="margin-bottom: 0.25rem;">Recipient confirmed: {{ shipment.recipient_confirmed_at|date:"M j, Y g:i a" }}</p>
                    {% endif %}

                    {% if user.id == shipment.sender_id %}
                        <div style="display: grid; gap: 0.5rem; margin-top: 0.5rem;">
                            <form method="post" action="{% url 'trades:trade_shipment_manual_tracking' trade.pk shipment.pk %}" style="display: grid; gap: 0.45rem;">
                                {% csrf_token %}
                                <div style="display: grid; gap: 0.45rem; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));">
                                    <input class="form-input" name="carrier" placeholder="Carrier (USPS, UPS, FedEx)" required>
                                    <input class="form-input" name="tracking_number" placeholder="Tracking number" required>
                                </div>
                                <button type="submit" class="btn btn-secondary">Save Tracking</button>
                            </form>
                            <form method="post" action="{% url 'trades:trade_shipment_buy_label' trade.pk shipment.pk %}" style="display: grid; gap: 0.45rem;">
                                {% csrf_token %}
                                <div style="display: grid; gap: 0.45rem; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));">
                                    <input class="form-input" name="weight_oz" placeholder="Weight oz" required>
                                    <input class="form-input" name="length_in" placeholder="Length in" required>
                                    <input class="form-input" name="width_in" placeholder="Width in" required>
                                    <input class="form-input" name="height_in" placeholder="Height in" required>
                                </div>
                                <button type="submit" class="btn btn-primary">Buy Shippo Label</button>
                            </form>
                        </div>
                    {% endif %}

                    {% if user.id == shipment.recipient_id and shipment.status == 'delivered' %}
                        <form method="post" action="{% url 'trades:trade_confirm_receipt' trade.pk shipment.pk %}" style="margin-top: 0.5rem;">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-primary">Confirm Receipt</button>
                        </form>
                    {% endif %}
                </div>
            {% empty %}
                <p>No shipment placeholders found.</p>
            {% endfor %}
        </div>
    </article>

    <article class="card">
        <h2 style="font-size: 1.2rem; margin-bottom: 0.55rem;">Offer History</h2>
        <div style="display: grid; gap: 0.45rem;">
            {% for h in history %}
                <p>
                    <a href="{% url 'trades:offer_detail' h.pk %}">#{{ h.pk }}</a> -
                    {{ h.from_user.username }} to {{ h.to_user.username }} -
                    {{ h.get_status_display }} -
                    {{ h.created_at|date:"M j, Y g:i a" }}
                </p>
            {% endfor %}
        </div>
    </article>

    {% if strikes %}
    <article class="card">
        <h2 style="font-size: 1.2rem; margin-bottom: 0.6rem;">Handshake For Exceptions</h2>
        <p style="color: var(--color-muted); margin-bottom: 0.6rem;">
            For legitimate exceptions, either side can initiate a handshake and the other side confirms within 72 hours.
        </p>
        <div style="display: grid; gap: 0.8rem;">
            {% for strike in strikes %}
                <div style="padding: 0.7rem; border: 1px solid #ddd; border-radius: 8px;">
                    <p><strong>Strike #{{ strike.pk }}</strong> - {{ strike.get_reason_display }} (applies to {{ strike.user.username }})</p>
                    <p style="color: var(--color-muted);">Issued {{ strike.created_at|date:"M j, Y g:i a" }}{% if strike.expires_at %}, expires {{ strike.expires_at|date:"M j, Y g:i a" }}{% endif %}</p>
                    {% if strike.notes %}<p>Notes: {{ strike.notes }}</p>{% endif %}
                    {% if strike.is_excused %}
                        <p style="color: #2c4a1e;"><strong>Excused</strong> by {{ strike.excuse_confirmed_by.username }}{% if strike.excuse_reason %} ({{ strike.get_excuse_reason_display }}){% endif %}.</p>
                    {% else %}
                        {% if strike.excuse_initiated_by %}
                            <p>Handshake initiated by {{ strike.excuse_initiated_by.username }}{% if strike.excuse_reason %} ({{ strike.get_excuse_reason_display }}){% endif %}.</p>
                            {% if strike.excuse_note %}<p>Note: {{ strike.excuse_note }}</p>{% endif %}
                            {% if strike.excuse_expires_at %}<p>Confirm by: {{ strike.excuse_expires_at|date:"M j, Y g:i a" }}</p>{% endif %}
                            {% if user.id != strike.excuse_initiated_by_id %}
                                <form method="post" action="{% url 'trades:trade_confirm_excuse' trade.pk strike.pk %}">
                                    {% csrf_token %}
                                    <button class="btn-secondary" type="submit">Confirm Handshake</button>
                                </form>
                            {% endif %}
                        {% else %}
                            <form method="post" action="{% url 'trades:trade_initiate_excuse' trade.pk strike.pk %}" style="display: grid; gap: 0.45rem; margin-top: 0.5rem;">
                                {% csrf_token %}
                                <select class="form-input" name="excuse_reason" required>
                                    <option value="">Select reason</option>
                                    {% for value, label in excuse_reason_choices %}
                                        <option value="{{ value }}">{{ label }}</option>
                                    {% endfor %}
                                </select>
                                <input class="form-input" name="excuse_note" placeholder="Optional note (max 250 chars)">
                                <div><button class="btn-secondary" type="submit">Initiate Handshake</button></div>
                            </form>
                        {% endif %}
                    {% endif %}
                </div>
            {% endfor %}
        </div>
    </article>
    {% endif %}
</section>
{% endblock %}
