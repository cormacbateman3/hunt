{% extends 'base.html' %}
{% load static %}

{% block title %}{{ listing.title }} | KeystoneBid{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/pages/listing.css' %}">
{% endblock %}

{% block content %}
<article class="listing-detail">
    <section class="card">
        <h1 style="margin-bottom: 0.75rem;">{{ listing.title }}</h1>

        {% if listing.featured_image %}
            <img
                id="gallery-main"
                data-gallery-main
                src="{{ listing.featured_image.url }}"
                alt="{{ listing.title }}"
                style="border-radius: 8px; margin-bottom: 0.6rem; width: 100%; max-height: 460px; object-fit: contain; background: #f0eadb;"
            >
        {% endif %}

        {% if listing.additional_images.all %}
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem; margin-bottom: 1rem;">
                {% if listing.featured_image %}
                    <button type="button" class="btn-secondary" style="padding: 0;" data-gallery-thumb data-full-src="{{ listing.featured_image.url }}">
                        <img src="{{ listing.featured_image.url }}" alt="Featured image thumbnail" style="width: 100%; border-radius: 6px;">
                    </button>
                {% endif %}
                {% for image in listing.additional_images.all %}
                    <button type="button" class="btn-secondary" style="padding: 0;" data-gallery-thumb data-full-src="{{ image.image.url }}">
                        <img src="{{ image.image.url }}" alt="Additional image {{ forloop.counter }}" style="width: 100%; border-radius: 6px;">
                    </button>
                {% endfor %}
            </div>
        {% endif %}

        <p style="margin-bottom: 1rem;">{{ listing.description }}</p>

        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
            <button type="button" class="btn-secondary" data-gallery-prev>Previous image</button>
            <button type="button" class="btn-secondary" data-gallery-next>Next image</button>
            <button type="button" class="btn-secondary" data-gallery-zoom>Zoom</button>
        </div>
    </section>

    <aside
        class="card"
        {% if is_auction %}
        data-poll-url="{% url 'listings:bid_status' listing.id %}"
        data-bid-target="#current-bid-value"
        data-bid-count-target="#bid-count-value"
        data-min-bid-target="#min-bid-value"
        data-auction-end-target="#countdown-value"
        {% endif %}
    >
        <h2 style="font-size: 1.2rem; margin-bottom: 0.75rem;">{{ listing.get_listing_type_display }} details</h2>
        {% if is_auction %}
        <p><strong>Current price:</strong> $<span id="current-bid-value">{{ listing.current_price }}</span></p>
        <p><strong>Minimum next bid:</strong> $<span id="min-bid-value">{{ minimum_bid }}</span></p>
        <p><strong>Total bids:</strong> <span id="bid-count-value">{{ bid_count }}</span></p>
        <p>
            <strong>Time remaining:</strong>
            <span id="countdown-value" data-auction-end="{{ listing.auction_end|date:'c' }}">
                --
            </span>
        </p>
        {% elif is_buy_now %}
        <p><strong>Price:</strong> {% if listing.buy_now_price %}${{ listing.buy_now_price }}{% else %}-{% endif %}</p>
        {% else %}
        <p><strong>Trade preferences:</strong></p>
        <p>{{ listing.trade_notes|default:"No specific preferences listed." }}</p>
        <p><strong>Cash add-on:</strong> {% if listing.allow_cash %}Allowed{% else %}Not allowed{% endif %}</p>
        {% endif %}
        <p><strong>County:</strong> {% if listing.county_ref %}{{ listing.county_ref.name }}{% else %}{{ listing.county }}{% endif %}</p>
        <p><strong>Year:</strong> {{ listing.license_year }}</p>
        <p><strong>Type:</strong> {% if listing.license_type_ref %}{{ listing.license_type_ref.name }}{% else %}{{ listing.license_type }}{% endif %}</p>
        <p><strong>Condition:</strong> {{ listing.get_condition_grade_display }}</p>
        <p><strong>Status:</strong> {{ listing.get_status_display }}</p>
        {% if is_auction %}
        <p><strong>Auction ends:</strong> {{ listing.auction_end|date:"M j, Y, g:i a" }}</p>
        {% endif %}

        {% if user.is_authenticated and listing.seller_id == user.id %}
            <div style="margin-top: 1rem;">
                <a class="btn-secondary" href="{% url 'listings:edit' listing.pk %}">Edit listing</a>
            </div>
        {% elif user.is_authenticated and is_auction %}
            <hr style="margin: 1rem 0; border: 0; border-top: 1px solid var(--color-border);">
            <h3 style="font-size: 1.05rem; margin-bottom: 0.75rem;">Place bid</h3>
            {% if user.profile.email_verified %}
                <form method="post" action="{% url 'bids:create' listing.id %}" data-bid-form>
                    {% csrf_token %}
                    <label class="form-label" for="{{ bid_form.amount.id_for_label }}">Bid amount ($)</label>
                    {{ bid_form.amount }}
                    <small style="color: var(--color-muted);">Minimum: $<span id="min-bid-helper">{{ minimum_bid }}</span></small>
                    <div style="margin-top: 0.75rem;">
                        <button type="submit" class="btn-primary">Submit bid</button>
                    </div>
                </form>
            {% else %}
                <p style="color: var(--color-hunting-rust);">
                    Verify your email before placing bids.
                </p>
            {% endif %}
            {% if user_bid %}
                <p style="margin-top: 0.8rem; color: var(--color-muted);">
                    Your highest bid: ${{ user_bid.amount }}
                </p>
            {% endif %}
        {% elif user.is_authenticated and is_buy_now %}
            {% if can_buy_now %}
                <form method="post" action="{% url 'listings:buy_now_checkout_start' listing.pk %}" style="margin-top: 1rem;">
                    {% csrf_token %}
                    <button type="submit" class="btn-primary">Buy now</button>
                </form>
            {% elif can_resume_buy_now %}
                <p style="margin-top: 1rem; color: var(--color-muted);">You already started checkout for this listing.</p>
                <a class="btn-primary" href="{% url 'payments:checkout' buy_now_order.pk %}">Resume checkout</a>
            {% elif buy_now_locked %}
                <p style="margin-top: 1rem; color: var(--color-hunting-rust);">
                    This listing is currently locked by another buyer's checkout session.
                </p>
            {% else %}
                <p style="margin-top: 1rem; color: var(--color-muted);">
                    This listing is no longer available for buy now.
                </p>
            {% endif %}
        {% elif user.is_authenticated and is_trade %}
            {% if listing.seller_id == user.id %}
                <p style="margin-top: 1rem; color: var(--color-muted);">
                    Offers received: {{ trade_offer_count }}
                </p>
                {% if latest_trade_offer %}
                    <a class="btn-secondary" href="{% url 'trades:offer_detail' offer_id=latest_trade_offer.id %}">
                        View latest offer
                    </a>
                {% else %}
                    <p style="color: var(--color-muted);">No offers yet.</p>
                {% endif %}
            {% else %}
                <a class="btn-primary" href="{% url 'trades:propose' listing_id=listing.id %}" style="margin-top: 1rem; display:inline-block;">
                    Propose trade
                </a>
            {% endif %}
        {% elif is_auction %}
            <p style="margin-top: 1rem;">
                <a class="btn-primary" href="{% url 'accounts:login' %}?next={{ request.path }}">Login to bid</a>
            </p>
        {% elif is_buy_now %}
            <p style="margin-top: 1rem;">
                <a class="btn-primary" href="{% url 'accounts:login' %}?next={{ request.path }}">Login for buy now</a>
            </p>
        {% else %}
            <p style="margin-top: 1rem;">
                <a class="btn-primary" href="{% url 'accounts:login' %}?next={{ request.path }}">Login to propose trade</a>
            </p>
        {% endif %}
    </aside>
</article>

{% if is_auction %}
<section class="card" style="margin-top: 1rem;">
    <h2 style="font-size: 1.2rem; margin-bottom: 0.75rem;">Recent bids</h2>
    {% if recent_bids %}
        <div style="display: grid; gap: 0.45rem;">
            {% for bid in recent_bids %}
                <p>
                    ${{ bid.amount }} by {{ bid.bidder.username }} on {{ bid.placed_at|date:"M j, Y g:i a" }}
                    {% if bid.is_winning %}<strong>(winning)</strong>{% endif %}
                </p>
            {% endfor %}
        </div>
    {% else %}
        <p>No bids yet.</p>
    {% endif %}
</section>
{% endif %}
{% endblock %}
